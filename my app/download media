import yt_dlp
import tkinter as tk
from tkinter import ttk, messagebox, font
import threading
import os
import sys
from PIL import Image, ImageTk

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ· (Light Mode Professional) ---
BG_COLOR = "#f0f2f5"      # Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹
CARD_BG = "#FFFFFF"      # Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ¶Ø§Ø¡
SHADOW_COLOR = "#e4e6eb" # Ù„ÙˆÙ† Ø§Ù„Ø¸Ù„
ACCENT_COLOR = "#1877f2" # Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ (Ø´Ø¨ÙŠÙ‡ ÙÙŠØ³Ø¨ÙˆÙƒ)
ACCENT_HOVER = "#166fe5" # Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø£ØºÙ…Ù‚
SUCCESS_COLOR = "#42b983" # Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ù„Ù„Ù†Ø¬Ø§Ø­
ERROR_COLOR = "#fa383e"   # Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£
TEXT_COLOR = "#1c1e21"   # Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³ÙˆØ¯
SUBTLE_TEXT = "#606770" # Ù„ÙˆÙ† Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ
FONT_FAMILY = "SF Pro Display" # Ø®Ø· Ø­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ùƒ
FONT_SIZE = 13

# --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---

def resource_path(relative_path):
    """Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø¯Ø§Ø®Ù„ Ø­Ø²Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"""
    try:
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)

def get_desktop_path():
    """Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨"""
    return os.path.join(os.path.expanduser('~'), 'Desktop')

def fetch_video_info():
    """Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) Ø¹Ù†Ø¯ Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø·"""
    url = url_entry.get()
    if not url:
        title_label.config(text="ğŸ”— Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„ØµÙˆØª...", fg=SUBTLE_TEXT)
        return

    try:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… yt-dlp Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        with yt_dlp.YoutubeDL({'quiet': True}) as ydl:
            info_dict = ydl.extract_info(url, download=False)
            video_title = info_dict.get('title', 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…ØªÙˆÙØ±')
            title_label.config(text=f"ğŸ“¹ {video_title[:60]}...", fg=TEXT_COLOR)
    except Exception:
        title_label.config(text="âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.", fg=ERROR_COLOR)

# --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---

def progress_hook(d):
    """ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù†"""
    if d['status'] == 'downloading':
        total_bytes = d.get('total_bytes') or d.get('total_bytes_estimate', 0)
        downloaded_bytes = d.get('downloaded_bytes', 0)
        if total_bytes > 0:
            percentage = (downloaded_bytes / total_bytes) * 100
            progress_bar['value'] = percentage
            status_label.config(text=f"ğŸš€ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... {percentage:.1f}%", fg=TEXT_COLOR)
            root.update_idletasks()
    elif d['status'] == 'finished':
        status_label.config(text="âš™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ù„Ù...", fg=SUCCESS_COLOR)
        progress_bar['value'] = 100

def start_download():
    """Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„"""
    url = url_entry.get()
    if not url:
        messagebox.showerror("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·.")
        return

    choice = format_var.get()
    desktop_path = get_desktop_path()
    
    # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    download_button.config(state=tk.DISABLED)
    url_entry.config(state=tk.DISABLED)
    progress_bar['value'] = 0
    status_label.config(text="â³ ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", fg=TEXT_COLOR)

    ydl_opts = {
        'outtmpl': os.path.join(desktop_path, '%(title)s.%(ext)s'),
        'progress_hooks': [progress_hook],
    }

    # --- ØªØ­Ø³ÙŠÙ† Ù…ÙƒØ§Ù† ffmpeg ---
    ffmpeg_path = resource_path('ffmpeg')
    if os.path.isfile(ffmpeg_path) and os.access(ffmpeg_path, os.X_OK):
        ydl_opts['ffmpeg_location'] = ffmpeg_path
        print("Using bundled ffmpeg.")
    else:
        print("Using system ffmpeg.")
        
    try:
        if choice == 'mp4':
            ydl_opts['format'] = 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio/best'
            ydl_opts['postprocessors'] = [{'key': 'FFmpegVideoConvertor', 'preferedformat': 'mp4'}]
            status_label.config(text="ğŸ¬ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø©...")
        
        elif choice == 'mp3':
            ydl_opts['format'] = 'bestaudio/best'
            ydl_opts['postprocessors'] = [{'key': 'FFmpegExtractAudio', 'preferredcodec': 'mp3', 'preferredquality': '192'}]
            status_label.config(text="ğŸµ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØªØ­ÙˆÙŠÙ„Ù‡...")
        
        download_thread = threading.Thread(target=run_download, args=(url, ydl_opts), daemon=True).start()

    except Exception as e:
        messagebox.showerror("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
        reset_ui()

def run_download(url, opts):
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„"""
    try:
        with yt_dlp.YoutubeDL(opts) as ydl:
            ydl.download([url])
        root.after(0, lambda: messagebox.showinfo("âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„", f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨!"))
    except Exception as e:
        error_message = f"ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.\n\nØ§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„:\n{str(e)}"
        root.after(0, lambda: messagebox.showerror("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", error_message))
    finally:
        root.after(0, reset_ui)

def reset_ui():
    """Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©"""
    download_button.config(state=tk.NORMAL)
    url_entry.config(state=tk.NORMAL)
    progress_bar['value'] = 0
    status_label.config(text=" Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„", fg=SUBTLE_TEXT)
    fetch_video_info() # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ

# --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© ---
root = tk.Tk()
root.title("App Downloader Pro")
root.geometry("650x550")
root.configure(bg=BG_COLOR)
root.resizable(False, False)
# --- Ø£Ù‡Ù… Ø³Ø·Ø±: Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ---
root.overrideredirect(False) # Ø¯ÙŠ Ø¨ØªØ®Ø¨Ø± Ø§Ù„Ù…Ø§Ùƒ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨ØªØ§Ø¹ØªÙ‡

# --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ---
try:
    download_img = ImageTk.PhotoImage(Image.open(resource_path("icons/download.png")).resize((24, 24), Image.Resampling.LANCZOS))
    video_img = ImageTk.PhotoImage(Image.open(resource_path("icons/video.png")).resize((20, 20), Image.Resampling.LANCZOS))
    audio_img = ImageTk.PhotoImage(Image.open(resource_path("icons/music.png")).resize((20, 20), Image.Resampling.LANCZOS))
except Exception as e:
    print(f"Warning: Could not load icons: {e}")
    download_img = video_img = audio_img = None

# --- ØªØ®ØµÙŠØµ Ø´ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Styling) ---
style = ttk.Style(root)
style.theme_use('clam')
style.configure('TFrame', background=CARD_BG, borderwidth=0)
style.configure('Card.TFrame', background=CARD_BG, relief='solid', borderwidth=1)
style.configure('Shadow.TFrame', background=SHADOW_COLOR, borderwidth=0)
style.configure('TLabel', background=CARD_BG, foreground=TEXT_COLOR, font=(FONT_FAMILY, FONT_SIZE))
style.configure('TButton', font=(FONT_FAMILY, FONT_SIZE, 'bold'), foreground='white', background=ACCENT_COLOR, borderwidth=0, focuscolor='none')
style.map('TButton', background=[('active', ACCENT_HOVER), ('pressed', ACCENT_HOVER)])
style.configure('TRadiobutton', background=CARD_BG, foreground=TEXT_COLOR, font=(FONT_FAMILY, FONT_SIZE))
style.configure('TEntry', fieldbackground=BG_COLOR, borderwidth=1, font=(FONT_FAMILY, FONT_SIZE), insertcolor=TEXT_COLOR)
style.map('TEntry', focuscolor=[('focus', ACCENT_COLOR)])
style.configure('TProgressbar', background=ACCENT_COLOR, troughcolor=BG_COLOR, borderwidth=0, lightcolor=ACCENT_COLOR, darkcolor=ACCENT_COLOR)

# --- Ø¥Ø·Ø§Ø± Ø§Ù„Ø¸Ù„ (Ù„Ù„Ø¹Ù…Ù‚) ---
shadow_frame = ttk.Frame(root, style='Shadow.TFrame')
shadow_frame.pack(expand=True, fill='both', padx=22, pady=22)

# --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
main_card = ttk.Frame(shadow_frame, padding="40", style='Card.TFrame')
main_card.pack(expand=True, fill='both')

# --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
# Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ø¢Ù† Ø¨Ø³ÙŠØ· ÙˆØ¬ÙˆÙ‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©)
title_font = font.Font(family=FONT_FAMILY, size=22, weight="bold")
title_label = tk.Label(main_card, text="App Downloader Pro", font=title_font, bg=CARD_BG, fg=TEXT_COLOR)
title_label.grid(row=0, column=0, columnspan=2, pady=(0, 25))

# Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·
url_label = ttk.Label(main_card, text="ğŸ”— Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„ØµÙˆØª:")
url_label.grid(row=1, column=0, columnspan=2, sticky="w", pady=(0, 5))

url_entry = ttk.Entry(main_card, width=60, font=(FONT_FAMILY, FONT_SIZE))
url_entry.grid(row=2, column=0, columnspan=2, sticky="ew", pady=(0, 5))
url_entry.bind("<KeyRelease>", lambda event: fetch_video_info())
url_entry.focus_set() # Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ

# Ø¹Ø±Ø¶ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
title_label = tk.Label(main_card, text="ğŸ” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø­Ø«...", font=(FONT_FAMILY, FONT_SIZE - 1), bg=CARD_BG, fg=SUBTLE_TEXT)
title_label.grid(row=3, column=0, columnspan=2, sticky="w", pady=(0, 20))

# Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (Ø¸Ø§Ù‡Ø±Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹)
format_frame = ttk.Frame(main_card, style='TFrame')
format_frame.grid(row=4, column=0, columnspan=2, pady=10)

format_var = tk.StringVar(value="mp4")
mp4_radio = ttk.Radiobutton(format_frame, text=" MP4 (ÙÙŠØ¯ÙŠÙˆ)", variable=format_var, value="mp4", image=video_img, compound='left')
mp4_radio.pack(side="right", padx=20)
mp3_radio = ttk.Radiobutton(format_frame, text=" MP3 (ØµÙˆØª)", variable=format_var, value="mp3", image=audio_img, compound='left')
mp3_radio.pack(side="right", padx=20)

# Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
button_text = "  ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†"
if download_img:
    download_button = ttk.Button(main_card, text=button_text, image=download_img, compound=tk.LEFT, command=start_download)
else:
    download_button = ttk.Button(main_card, text=button_text, command=start_download)
download_button.grid(row=5, column=0, columnspan=2, pady=20)
if download_img: download_button.image = download_img

# Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
progress_bar = ttk.Progressbar(main_card, orient="horizontal", length=550, mode='determinate')
progress_bar.grid(row=6, column=0, columnspan=2, sticky="ew", pady=(10, 5))

# Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
status_label = tk.Label(main_card, text=" Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„", font=(FONT_FAMILY, FONT_SIZE - 1), bg=CARD_BG, fg=SUBTLE_TEXT)
status_label.grid(row=7, column=0, columnspan=2, sticky="ew", pady=(5, 0))

# ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
footer_label = tk.Label(main_card, text="Made by abdallah", font=(FONT_FAMILY, 10), bg=CARD_BG, fg=SUBTLE_TEXT)
footer_label.grid(row=8, column=0, columnspan=2, pady=(15, 0))


root.mainloop()
